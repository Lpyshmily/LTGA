# LTGA_4

使用**NLOPT**优化器进行优化。

* [1st version](#20201126-1st-version)

* [2nd version](#20201127-2nd-version)

* [3rd version](#20201127-3rd-version)

* [4th version](#20201129-4th-version)

* [5th version](#20201130-5th-version)

* [6th version](#20201201-6th-version)

## 20201126 1st version

编写将引力辅助时间、引力辅助半径、`vout`的方向角作为3个优化变量的目标函数`GA_obj_nlopt()`。

以[0.87704,0.0,0.469045]为初值，用NLOPT优化器进行优化，共迭代64次，最终结果是[0.876915432598294,0.0,0.471101375017972]，剩余质量为15842.254755816450000kg。

换用一个较差的初值[0.5,0.5,0.5]，验证能否收敛到上述结果。

迭代82次，最终结果是[0.876959627917576,0.0,0.471123454181230]，剩余质量为15842.254754116961000kg。

NLOPT效果很好。

## 20201127 2nd version

将第一段轨迹末端相对于火星的相对速度的三个分量作为优化变量，求解两段燃料最优交会问题。

首先构造6变量的目标函数`GA_obj_nlopt_6()`

```c++
// x[6] 0-引力辅助时间 1-引力辅助半径 2-vout方向角 3-5 引力辅助前相对速度vin的3个分量
// 求解两段燃料最优交会问题
// 三个分量的变化范围均为0-1，对应以下不同含义
// 引力辅助时间指第引力辅助前第一段轨迹的转移时间，变化范围为[0.3,0.35]tf
// 引力辅助半径变化范围为[1,2]rmin
// vout方向角指vout和vin、vp组成的平面的夹角，变化范围为[0,pi]
// vin3个分量的变化范围均为[-0.1,0.1]
// para NULL
double GA_obj_nlopt_6(unsigned n, const double* x, double* grad, void* para)
```

用[1st version](#20201126-1st-version)中的结果进行测试，6变量的值为[0.876959627917576,0.0,0.471123454181230,0.201,0.3573,0.6245]。

测试成功，最终结果为15842.331kg。

## 20201127 3rd version

用NLOPT对6变量的目标函数进行优化。

以[0.876959627917576,0.0,0.471123454181230,0.201,0.3573,0.6245]为初值，共迭代98次，最终结果为[0.8754359,0.0,0.4370229,0.2028572463,0.3,0.623]，剩余质量为15855.175441277681kg。

> 在优化过程中，会出现最优转移时间满足条件，但是燃料最优不收敛的情况。

由于NLOPT进行的是局部优化，很可能是局部最优解，应该事先用PSO进行全局优化，再用PSO的结果作为初值进行局部优化。

## 20201129 4th version

* PSO优化

    运行结果为[0.999709099304766,0.004722508503925,0.470617494430747,0.239538394402327,0.275113612765333,0.666440534595599]，剩余质量为15889.122481630415kg。

    关于这个结果，衍生出两种想法：

    1. 第一个变量约等于1，说明引力辅助时间非常接近给定的上限值0.35，这意味着最优的引力辅助时间可能超过这个上限，而且根据已知的最优解，引力辅助时间为0.3876，确实超过了当前引力辅助时间的范围。
    
        解决方法是：引力辅助时间的搜索范围扩大，从原来的[0.3,0.35]扩大到[0.3,0.4]。在函数`GA_obj_PSO_6_new()`和`GA_PSO_6_new()`中进行实现。（目前还没有运行）

    2. 对当前的最优解进行验证，分别用`GA_obj_PSO_6()`和`GA_obj_PSO_6_new()`进行验证，第一次燃料最优交会问题随机猜测100次很难收敛，增加最大随机猜测次数可以收敛。
    
        > 这个问题在[3rd verion](#20201127-3rd-version)中也遇到过。
        
        为了解决这一问题，将随机猜测次数增加到1000次，并计划用春分点轨道根数代替直角坐标进行求解/增加同伦过程。

## 20201130 5th version

[4th version](#20201129-4th-version)中提到第一次燃料最优交会问题求解困难，为了解决这一问题，提出两种解决方案：

* 用春分点轨道根数代替直角坐标进行求解

    仍然很难收敛。

* 加入同伦过程

    春分点轨道根数表示，同伦参数为1.0，很难收敛。

    直角坐标表示，同伦参数为1.0或0.1，非常容易收敛。

    同伦过程不容易控制，没有一个统一的方法使得同伦过程的每一步都收敛。

    同伦过程由于数值精度的原因，每次运行结果不同，很不稳定。

最终决定，对这部分不进行改进，设置最大随机猜测次数为1000。

## 20201201 6th version

6变量PSO，去掉不必要的过程输出。

* 服务器第一次运行结果

    [0.442678189817599,0.675347632787319,0.779213936549869,0.762206115282559,0.444197635929117,0.805240918369319]，剩余质量为15901.610302449071kg。
    
    本机验证：第一段最优转移时间大于所给时间，无法完成转移。

* 本机小规模运行结果（种群数量Np=20，10代），用时0.59h

    迭代5次之后，达到本次计算的最优结果，后面5代没有提升。

    [0.835081582804654,0.81916520481803,0.980067774587983,0.445483636204955,0.395957969028497,0.504427028426711]，剩余质量为15644.8856382163kg。

    本机验证：第二段最优转移时间大于所给时间，无法完成转移。

* 本机小规模运行结果（种群数量Np=20，3代）改用张楠的PSO程序，用时392s

    [0.156453285520958,0.362268870346017,0.43434812734325,0.0540535220853704,0.523862322156581,0.522619956078773]，剩余质量为15151.6825392052kg。

    本机验证成功。

    在张楠的帮助下，比对两个PSO程序在并行模式下的不同，发现我之前所用的程序在并行部分使用了“全局变量”`index`，导致优化变量和目标函数值无法对应，所以出现了前面的错误。

* 本机小规模运行结果（种群数量Np=20，10代），用时

    [0.543792939126649,0.0456862086855678,0.475299569653442,0.282035941097635,0.120845053155045,0.375387105749494]，剩余质量为15766.011995154884kg。

    本机验证成功

* 服务器运行中（种群数量Np=40，500代）