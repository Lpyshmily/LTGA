# LTGA_3

* [1st version](#20201117-1st-version)

* [2nd version](#20201117-2nd-version)

* [3rd version](#20201118-3rd-version)

* [4th version](#20201119-4th-version)

* [5th version](#20201123-5th-version)

* [6th version](#20201124-6th-version)

* [7th version](#20201126-7th-version)

* [8th version](#20201127-8th-version)

## 20201117 1st version

复制LTGA_2，进行`factor=0.34`的简单测试，程序可以正常运行。

## 20201117 2nd version

* 删掉一些无关的test函数

* 修改引力辅助模型

    仍然只用引力辅助时间作为变量，但是对引力辅助模型进行了修改，设定引力辅助半径为所允许的最小引力辅助半径，假设`vin`、`vp`和`vout`在同一平面内。

    令`factor=0.347`，剩余质量为15822.684kg，小于之前模型下的剩余质量。

    检查之前的引力辅助模型下的引力辅助半径，发现确实小于允许的最小引力辅助半径。

## 20201118 3rd version

* 在修正后的平面引力辅助模型下，设置比例系数为0.25-0.45，以0.01为间隔，计算剩余质量，运行结果为[info_1605677113.txt](LTGA_3/LTGA_3/info_1605677113.txt)。

    当比例系数在0.30-0.35的范围时，可以完成转移，`factor=0.34`时，剩余质量最大，为15821.786kg。

* 设置比例系数为0.33-0.35，以0.001为间隔，计算剩余质量，运行结果为[info_1605677943.txt](LTGA_3/LTGA_3/info_1605677943.txt)

    比例系数为0.335时，不能完成转移，重新计算，将结果加入到上面的文件中。

    `factor=0.344`时，剩余质量最大，为15839.980kg，略大于错误模型的最大剩余质量。

    > 采用错误模型时，比例系数为0.347时，剩余质量最大，为15839.873kg。

## 20201119 4th version

* 将引力辅助时间、引力辅助半径、`vout`的方向角作为3个优化变量，编写目标函数`GA_obj_triple()`。

    引力辅助时间指第引力辅助前第一段轨迹的转移时间，变化范围为[0,tf]。

    引力辅助半径变化范围为[rmin,2rmin]。

    `vout`方向角指`vout`和`vin`、`vp`组成的平面的夹角，变化范围为[0,2pi]。

    通过变换，将三个优化变量的范围都限制在0-1之间，用[0.344,0.0,0.25]验证，程序可以正确运行。

* 设置三个优化变量的范围与间隔，计算剩余质量

    变化范围分别为0.25-0.45，0.0-1.0，0.0-1.0，间隔分别为0.01、0.1、0.1，离散点个数分别为21、11、11，因此总的计算次数为2541次，预计需要14个小时。

    并行会导致输出结果混乱，因此不采用并行。

    最好的结果是0.34，0，0.2，即引力辅助时间为0.34，引力辅助半径为rmin，旋转角为0.4pi，剩余质量为15821.882kg。

* 针对上一步的计算结果，重新规划三个变量的范围

    变化范围分别为0.3-0.35，0.0-1.0，0.0-0.5。

## 20201123 5th version

* 修改三个变量的范围，编写PSO的目标函数

    用引力辅助时间0.34，引力辅助半径rmin，旋转角0.6pi的算例进行验证，剩余质量为15780.957kg，结果正确。

* PSO搜索

    不设置初始近似解。

    偶尔会在一个地方卡住，偏差与步长趋于无穷，为了方便查找问题来源，不采用并行。

    运行结果：引力辅助时间为0.343852，引力辅助半径为1.000017*最小引力辅助半径，旋转角为=0.469045pi，剩余质量为15842.234388kg。

    PSO提升幅度有限，还是需要从方法上寻求突破。

## 20201124 6th version

学习使用非线性规划程序包NPSOL。

用NPSOL求解三变量的引力辅助优化问题，程序中出现严重bug，查找原因是头文件的顺序导致错误，目前已改正，错误文件保存为[wrong.cpp](LTGA_3/LTGA_3/wrong.cpp)。

目前程序可以正常运行，但是只在初值附近进行了几次计算就终止，终止原因是

> Exit NPSOL - Large errors found in the derivatives.

程序运行中间也出现

> XXX  The objective gradients seem to be incorrect.

意思大致是**目标函数的梯度太大**，目前还没有解决办法。

## 20201126 7th version

调试NPSOL程序

1. 调试过程中发现，NPSOL的步长很小。

2. 根据说明文档，应该是人为提供了目标函数的梯度，导致NPSOL在验证目标函数梯度时失败。

    查找到程序中的`npsolfnobj`和`npsolfncon`函数，发现里面对目标函数和非线性约束的导数进行了计算，但是计算是针对测试的简单算例，因此需要修改，修改方法是**直接去掉**。

3. 修改之后，用[0.8,0.01,0.45]作为初值，最终结果是[0.8,0.0,0.45]，剩余质量为15827.24kg，终止原因是

    > Exit NPSOL - Current point cannot be improved upon.

    inform的值为6，NPSOL用户手册上面的解释是：`x` does not satisfy the first-order optimality conditions to the required accuracy, and no improved point for the merit function could be found during the final linesearch.

    用PSO的最优解[0.87704,0.000017,0.469045]为初值，最终结果是[0.87704,0.0,0.469045]，剩余质量为15842.24kg，终止原因同上。

    用刚刚得到的结果作为初值，再次进行计算，结果不变。

4. 用[0.8,0.1,0.45]作为初值，Debug模式下逐步调试

    在某些值附近极小的范围内，会进行反复计算，而不是去拓展新领域。

    局部极小值？NPSOL的工作原理到底是怎么样的？

    调试到一个结果[0.800724,0.099764,0.451436]，剩余质量为15799.132kg，在这个结果附近进行了超过20次的计算，不得不退出调试模式。

    Release模式下运行，最终结果是[0.8,0.1,0.45]，剩余质量为15798.837kg，终止原因同上。

    > 注意：Release模式下的最终结果小于调试模式下的那个结果。

    Debug模式下运行，最终结果是[0.813209,0.049829,0.526087]，剩余质量为15805.28kg，终止原因同上，与Release模式下运行结果不同，且运行时间很长。

5. 随机给一个初值[0.5,0.5,0.5]，最终结果为[0.968214,0.004285,0.575315]，剩余质量为15761.78kg。

## 20201127 8th version

为了考察是否存在局部最优解，以`GA_obj_PSO()`为目标函数，三个变量范围均为0~1，划分10、10、10的网格，进行**网格搜索**。

对于生成的数据[info_1606383602.txt](LTGA_3/LTGA_3/info_1606383602.txt)进行分析，不存在局部最优解的问题。